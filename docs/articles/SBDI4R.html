<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to SBDI4R • SBDI4R</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to SBDI4R">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SBDI4R</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/SBDI4R.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/biodiversitydata-se/SBDI4R">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="SBDI4R_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Introduction to SBDI4R</h1>
                        <h4 class="author">Alejandro Ruete and Debora Arlt</h4>
            
            <h4 class="date">2020-10-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/biodiversitydata-se/SBDI4R/blob/master/vignettes/SBDI4R.Rmd"><code>vignettes/SBDI4R.Rmd</code></a></small>
      <div class="hidden name"><code>SBDI4R.Rmd</code></div>

    </div>

    
    
<div id="using-sbdi4r" class="section level2">
<h2 class="hasAnchor">
<a href="#using-sbdi4r" class="anchor"></a>Using SBDI4R</h2>
<p>Lets assume you have already installed the package as shown in the main site .</p>
<p>The SBDI4R package must be loaded for each new R session:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(SBDI4R)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">#&gt; This is a wrapper for the package ALA4R designed to work with data hosted by the Swedish Biodiversity Data Infrastructure (SBDI).</span></span></code></pre></div>
<p>However, the options you stored in .Rprofile if you did it so, will load automatically with the package. Then, check that we have some additional packages that we’ll use in the examples, and install them if necessary.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>to_install &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ape"</span>, <span class="st">"dplyr"</span>, <span class="st">"ggplot2"</span>, <span class="st">"jpeg"</span>, <span class="st">"maps"</span>, <span class="st">"mapdata"</span>,</span>
<span id="cb2-2"><a href="#cb2-2"></a>                <span class="st">"maptools"</span>, <span class="st">"phytools"</span>, <span class="st">"sp"</span>, <span class="st">"rgeos"</span>, <span class="st">"tidyr"</span>, <span class="st">"vegan"</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a>to_install &lt;-<span class="st"> </span>to_install[<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(to_install, requireNamespace, <span class="dt">quietly=</span><span class="ot">TRUE</span>)]</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="cf">if</span>(<span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(to_install)<span class="op">&gt;</span><span class="dv">0</span>)</span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="kw"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(to_install, <span class="dt">repos=</span><span class="st">"http://cran.us.r-project.org"</span>)</span></code></pre></div>
<p>#SHOULD WE BRING THE EXAMPLES FROM THE MAIN PAGE HERE? ### Example 2: Area report: what listed species exist in a given area?</p>
<p>Vector spatial layers (eg. Polygons) can be imported in a number of different ways. Bioatlas’ APIs take as search input polygons in the s.k. WKT (Well Known Text ). So the first step is to load a vector layer and transform it into a WKT string. First download a .zip file with different delimitations for Sweden  and move it somewhere you like in your computer. We recommend you move it into your working directory (). Extract the .zip file named KommunSweref99.zip. <!-- We use the ALA4R's caching mechanism here, but you could equally download this file directly. --></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># library(rgdal)</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co"># shape &lt;- readOGR(dsn=file.path("your/path/to/file", "Kommun_Sweref99TM_region.shp"))</span></span></code></pre></div>
<p>This will only work when you set a valid filepath, and will create an object of class SpatialPolygon. You could instead use the data we kindly provided in this package </p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>shape &lt;-<span class="st"> </span>swe<span class="op">$</span>Municipalities</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">## extract just the Municipality of Örebro</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>shape &lt;-<span class="st"> </span>shape[shape<span class="op">$</span>KnNamn<span class="op">==</span><span class="st">"Örebro"</span>, ]</span></code></pre></div>
<p>We could create the WKT string using the <code>rgeos</code> library:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(rgeos)</span>
<span id="cb5-2"><a href="#cb5-2"></a>wkt &lt;-<span class="st"> </span><span class="kw">writeWKT</span>(shape)</span></code></pre></div>
<p>Unfortunately, in this instance this gives a WKT string that is too long and won’t be accepted by the web service. Also, the shapefile we just got is projected in the coordinate system SWEREF99 TM, and the web service only accepts coordinates in a geodesic coordinate system WGS84. Instead, let’s construct the WKT string directly, which gives us a little more control over its format:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(sp)</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">#&gt; Warning: package 'sp' was built under R version 3.6.3</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>shape &lt;-<span class="st"> </span><span class="kw">spTransform</span>(shape, <span class="dt">CRSobj =</span> <span class="kw">CRS</span>(<span class="st">"+init=epsg:4326"</span>)) <span class="co">## the magic number for WGS84</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>lonlat &lt;-<span class="st"> </span>shape<span class="op">@</span>polygons[[<span class="dv">1</span>]]<span class="op">@</span>Polygons[[<span class="dv">1</span>]]<span class="op">@</span>coords <span class="co">## extract the polygon coordinates</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">## extract the convex hull of the polygon to reduce the length of the WKT string</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>temp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/grDevices/chull.html">chull</a></span>(lonlat)</span>
<span id="cb6-7"><a href="#cb6-7"></a>lonlat &lt;-<span class="st"> </span>lonlat[<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(temp, temp[<span class="dv">1</span>]), ]</span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">## create WKT string</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">## first join each lon-lat coordinate pair</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>temp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(lonlat, <span class="dv">1</span>, <span class="cf">function</span>(z) <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(z, <span class="dt">collapse=</span><span class="st">" "</span>))</span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">## now build the WKT string</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>wkt &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"POLYGON(("</span>, <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(temp, <span class="dt">collapse=</span><span class="st">","</span>), <span class="st">"))"</span>, <span class="dt">sep=</span><span class="st">""</span>)</span></code></pre></div>
<p>Now extract the species list in this polygon:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw"><a href="../reference/specieslist.html">specieslist</a></span>(<span class="dt">wkt=</span>wkt) <span class="op">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="st">    </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="kw">desc</span>(occurrenceCount)) <span class="op">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="st">    </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(speciesName, species, family, occurrenceCount) <span class="op">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="dv">10</span>)</span></code></pre></div>
<pre><code>#&gt; [1] "could not find function \"%&gt;%\""</code></pre>
<p>#FROM HERE ON NOT ADAPTED TO SBDI ### Example 4: Community composition and turnover</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(vegan)</span></code></pre></div>
<p>Define our area of interest as a transect running westwards from the Stockholm region, and download the occurrences of legumes (Fabaceae; a large family of flowering plants) in this area:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>wkt &lt;-<span class="st"> "POLYGON((14.94 58.88, 14.94 59.69, 18.92 59.69, 18.92 58.88, 14.94 58.88))"</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co">## define some environmental layers of interest [see sbdi_fields(fields_type = "occurrence")]</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co"># el10011 https://spatial.bioatlas.se/ws/layers/view/more/worldclim_bio_12</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co"># el10009 https://spatial.bioatlas.se/ws/layers/view/more/worldclim_bio_10</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>env_layers &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"el10009"</span>,<span class="st">"el10011"</span>) </span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="co">## Download the data.  We use the `occurrences()` function, adding environmental</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="co">## data via the 'extra' parameter. </span></span>
<span id="cb10-8"><a href="#cb10-8"></a>x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/occurrences.html">occurrences</a></span>(<span class="dt">taxon=</span><span class="st">"family:Fabaceae"</span>, <span class="dt">wkt=</span>wkt, <span class="dt">qa=</span><span class="st">"none"</span>,</span>
<span id="cb10-9"><a href="#cb10-9"></a>                 <span class="dt">download_reason_id=</span><span class="st">"testing"</span>, <span class="dt">extra=</span>env_layers)</span></code></pre></div>
<p>Convert this to a sites-by-species data.frame:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>xgridded &lt;-<span class="st"> </span>x<span class="op">$</span>data <span class="op">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="st">    </span><span class="co">## discard genus- and higher-level records</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="st">    </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(rank <span class="op">%in%</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="st">                  </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"species"</span>, <span class="st">"subspecies"</span>, <span class="st">"variety"</span>, <span class="st">"form"</span>, <span class="st">"cultivar"</span>)) <span class="op">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="st">    </span><span class="co">## bin into 0.5-degree bins</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">longitude=</span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(longitude<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, </span>
<span id="cb11-7"><a href="#cb11-7"></a>           <span class="dt">latitude=</span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(latitude<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, </span>
<span id="cb11-8"><a href="#cb11-8"></a>           <span class="dt">worldClimMeanTemperatureOfWarmestQuarter =</span> worldClimMeanTemperatureOfWarmestQuarter <span class="op">/</span><span class="dv">10</span>) <span class="op">%&gt;%</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="st">    </span><span class="co">## average environmental vars within each bin</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="st">    </span><span class="kw">group_by</span>(longitude,latitude) <span class="op">%&gt;%</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">worldClimAnnualPrecipitation =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(worldClimAnnualPrecipitation, <span class="dt">na.rm=</span><span class="ot">TRUE</span>),</span>
<span id="cb11-12"><a href="#cb11-12"></a>           <span class="dt">worldClimMeanTemperatureOfWarmestQuarter =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(worldClimMeanTemperatureOfWarmestQuarter, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="st">    </span><span class="co">## subset to vars of interest</span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="st">    </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(longitude, latitude, species, </span>
<span id="cb11-15"><a href="#cb11-15"></a>                  worldClimAnnualPrecipitation,</span>
<span id="cb11-16"><a href="#cb11-16"></a>                  worldClimMeanTemperatureOfWarmestQuarter) <span class="op">%&gt;%</span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="st">    </span><span class="co">## take one row per cell per species (presence)</span></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="st">    </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="st">    </span><span class="co">## calculate species richness</span></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">richness=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="st">    </span><span class="co">## convert to wide format (sites by species)</span></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">present=</span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="st">    </span><span class="kw">do</span>(tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span>(<span class="dt">data=</span>., <span class="dt">key=</span>species, <span class="dt">value=</span>present, <span class="dt">fill=</span><span class="dv">0</span>)) <span class="op">%&gt;%</span></span>
<span id="cb11-24"><a href="#cb11-24"></a><span class="st">    </span><span class="kw">ungroup</span>()</span>
<span id="cb11-25"><a href="#cb11-25"></a><span class="co">## where a species was not present, it will have NA: convert these to 0</span></span>
<span id="cb11-26"><a href="#cb11-26"></a>sppcols &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(xgridded),</span>
<span id="cb11-27"><a href="#cb11-27"></a>                   <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>, </span>
<span id="cb11-28"><a href="#cb11-28"></a>                     <span class="st">"worldClimAnnualPrecipitation"</span>, </span>
<span id="cb11-29"><a href="#cb11-29"></a>                     <span class="st">"worldClimMeanTemperatureOfWarmestQuarter"</span>,</span>
<span id="cb11-30"><a href="#cb11-30"></a>                     <span class="st">"richness"</span>))</span>
<span id="cb11-31"><a href="#cb11-31"></a>xgridded &lt;-<span class="st"> </span>xgridded <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_at</span>(sppcols, <span class="cf">function</span>(z) <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(z), <span class="dv">0</span>, z))</span></code></pre></div>
<p>The end result:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>xgridded</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="co">#&gt; # A tibble: 161 x 330</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="co">#&gt;    longitude latitude worldClimAnnual~ worldClimMeanTe~ richness `Lathyrus japon~ `Astragalus fil~ `Astragalus pen~</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="co">#&gt;        &lt;dbl&gt;    &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;    &lt;int&gt;            &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="co">#&gt;  1     -167      60                673              8.5        1                1                0                0</span></span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="co">#&gt;  2     -157      58.5              505             11.7        1                1                0                0</span></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="co">#&gt;  3     -150.     60               1354             11.2        1                1                0                0</span></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="co">#&gt;  4     -134      60.5              268             10.1        1                0                1                0</span></span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="co">#&gt;  5     -114      59                387             14.5        1                0                0                1</span></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="co">#&gt;  6     -113      59.5              367             14.2        2                0                0                0</span></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="co">#&gt;  7     -112.     59                376             14.8        3                0                0                0</span></span>
<span id="cb12-12"><a href="#cb12-12"></a><span class="co">#&gt;  8     -112.     59.5              360             14.7        1                0                0                0</span></span>
<span id="cb12-13"><a href="#cb12-13"></a><span class="co">#&gt;  9      -79      59                365              7.6        1                0                0                1</span></span>
<span id="cb12-14"><a href="#cb12-14"></a><span class="co">#&gt; 10      -78      58.5              NaN            NaN          1                1                0                0</span></span>
<span id="cb12-15"><a href="#cb12-15"></a><span class="co">#&gt; # ... with 151 more rows, and 322 more variables: `Astragalus iodanthus` &lt;dbl&gt;, `Lathyrus ochroleucus` &lt;dbl&gt;,</span></span>
<span id="cb12-16"><a href="#cb12-16"></a><span class="co">#&gt; #   `Astragalus danicus` &lt;dbl&gt;, `Astragalus frigidus` &lt;dbl&gt;, `Astragalus thionanthus` &lt;dbl&gt;, `Aeschynomene</span></span>
<span id="cb12-17"><a href="#cb12-17"></a><span class="co">#&gt; #   indica` &lt;dbl&gt;, `Oxytropis podocarpa` &lt;dbl&gt;, `Trifolium dubium` &lt;dbl&gt;, `Vicia orobus` &lt;dbl&gt;, `Anthyllis</span></span>
<span id="cb12-18"><a href="#cb12-18"></a><span class="co">#&gt; #   vulneraria` &lt;dbl&gt;, `Ononis spinosa` &lt;dbl&gt;, `Trifolium aureum` &lt;dbl&gt;, `Trifolium carolinianum` &lt;dbl&gt;, `Trifolium</span></span>
<span id="cb12-19"><a href="#cb12-19"></a><span class="co">#&gt; #   medium` &lt;dbl&gt;, `Trifolium repens` &lt;dbl&gt;, `Vicia sepium` &lt;dbl&gt;, `Vicia bakeri` &lt;dbl&gt;, `Lathyrus pratensis` &lt;dbl&gt;,</span></span>
<span id="cb12-20"><a href="#cb12-20"></a><span class="co">#&gt; #   `Vicia hirsuta` &lt;dbl&gt;, `Melilotus albus` &lt;dbl&gt;, `Melilotus altissimus` &lt;dbl&gt;, `Lupinus nootkatensis` &lt;dbl&gt;,</span></span>
<span id="cb12-21"><a href="#cb12-21"></a><span class="co">#&gt; #   `Medicago lupulina` &lt;dbl&gt;, `Lotus glaber` &lt;dbl&gt;, `Trifolium pratense` &lt;dbl&gt;, `Vicia cracca` &lt;dbl&gt;, `Cytisus</span></span>
<span id="cb12-22"><a href="#cb12-22"></a><span class="co">#&gt; #   scoparius` &lt;dbl&gt;, `Oxytropis campestris` &lt;dbl&gt;, `Lathyrus sylvestris` &lt;dbl&gt;, `Lotus corniculatus` &lt;dbl&gt;, `Trifolium</span></span>
<span id="cb12-23"><a href="#cb12-23"></a><span class="co">#&gt; #   nigrescens` &lt;dbl&gt;, `Vicia tetrasperma` &lt;dbl&gt;, `Trifolium micranthum` &lt;dbl&gt;, `Lathyrus niger` &lt;dbl&gt;, `Medicago</span></span>
<span id="cb12-24"><a href="#cb12-24"></a><span class="co">#&gt; #   falcata` &lt;dbl&gt;, `Vicia cassubica` &lt;dbl&gt;, `Lathyrus linifolius` &lt;dbl&gt;, `Genista tinctoria` &lt;dbl&gt;, `Hippocrepis</span></span>
<span id="cb12-25"><a href="#cb12-25"></a><span class="co">#&gt; #   emerus` &lt;dbl&gt;, `Trifolium fragiferum` &lt;dbl&gt;, `Lathyrus vernus` &lt;dbl&gt;, `Vicia faba` &lt;dbl&gt;, `Trifolium</span></span>
<span id="cb12-26"><a href="#cb12-26"></a><span class="co">#&gt; #   spadiceum` &lt;dbl&gt;, `Vicia lathyroides` &lt;dbl&gt;, `Astragalus glycyphyllos` &lt;dbl&gt;, `Lathyrus palustris` &lt;dbl&gt;, `Lupinus</span></span>
<span id="cb12-27"><a href="#cb12-27"></a><span class="co">#&gt; #   arboreus` &lt;dbl&gt;, `Ornithopus compressus` &lt;dbl&gt;, `Ornithopus pinnatus` &lt;dbl&gt;, `Vicia sativa` &lt;dbl&gt;, `Vicia</span></span>
<span id="cb12-28"><a href="#cb12-28"></a><span class="co">#&gt; #   villosa` &lt;dbl&gt;, `Lathyrus pisiformis` &lt;dbl&gt;, `Medicago sativa` &lt;dbl&gt;, `Trifolium montanum` &lt;dbl&gt;, `Lupinus</span></span>
<span id="cb12-29"><a href="#cb12-29"></a><span class="co">#&gt; #   polyphyllus` &lt;dbl&gt;, `Pisum sativum` &lt;dbl&gt;, `Trifolium incarnatum` &lt;dbl&gt;, `Laburnum alpinum` &lt;dbl&gt;, `Laburnum</span></span>
<span id="cb12-30"><a href="#cb12-30"></a><span class="co">#&gt; #   watereri` &lt;dbl&gt;, `Lathyrus tuberosus` &lt;dbl&gt;, `Melilotus indicus` &lt;dbl&gt;, `Lathyrus latifolius` &lt;dbl&gt;, `Lathyrus</span></span>
<span id="cb12-31"><a href="#cb12-31"></a><span class="co">#&gt; #   hirsutus` &lt;dbl&gt;, `Lathyrus sphaericus` &lt;dbl&gt;, `Lotus pedunculatus` &lt;dbl&gt;, `Robinia pseudoacacia` &lt;dbl&gt;, `Trifolium</span></span>
<span id="cb12-32"><a href="#cb12-32"></a><span class="co">#&gt; #   hybridum` &lt;dbl&gt;, `Vicia pannonica` &lt;dbl&gt;, `Vicia tenuifolia` &lt;dbl&gt;, `Galega orientalis` &lt;dbl&gt;, `Laburnum</span></span>
<span id="cb12-33"><a href="#cb12-33"></a><span class="co">#&gt; #   anagyroides` &lt;dbl&gt;, `Securigera varia` &lt;dbl&gt;, `Ulex europaeus` &lt;dbl&gt;, `Lens culinaris` &lt;dbl&gt;, `Lupinus</span></span>
<span id="cb12-34"><a href="#cb12-34"></a><span class="co">#&gt; #   luteus` &lt;dbl&gt;, V1 &lt;dbl&gt;, `Acacia dealbata` &lt;dbl&gt;, `Acacia longifolia` &lt;dbl&gt;, `Acacia paradoxa` &lt;dbl&gt;, `Acacia</span></span>
<span id="cb12-35"><a href="#cb12-35"></a><span class="co">#&gt; #   saligna` &lt;dbl&gt;, `Amorpha fruticosa` &lt;dbl&gt;, `Anthyllis montana` &lt;dbl&gt;, `Anthyllis variegata` &lt;dbl&gt;, `Apios</span></span>
<span id="cb12-36"><a href="#cb12-36"></a><span class="co">#&gt; #   americana` &lt;dbl&gt;, `Arachis hypogaea` &lt;dbl&gt;, `Argyrocytisus battandieri` &lt;dbl&gt;, `Astragalus alopecurus` &lt;dbl&gt;,</span></span>
<span id="cb12-37"><a href="#cb12-37"></a><span class="co">#&gt; #   `Astragalus chamaeleuce` &lt;dbl&gt;, `Astragalus dactylocarpus` &lt;dbl&gt;, `Astragalus exscapus` &lt;dbl&gt;, `Astragalus</span></span>
<span id="cb12-38"><a href="#cb12-38"></a><span class="co">#&gt; #   fissuralis` &lt;dbl&gt;, `Astragalus hymenostegis` &lt;dbl&gt;, `Astragalus leontinus` &lt;dbl&gt;, `Astragalus leucolobus` &lt;dbl&gt;,</span></span>
<span id="cb12-39"><a href="#cb12-39"></a><span class="co">#&gt; #   `Astragalus mongholicus` &lt;dbl&gt;, `Astragalus musiniensis` &lt;dbl&gt;, `Astragalus nevadensis` &lt;dbl&gt;, `Astragalus</span></span>
<span id="cb12-40"><a href="#cb12-40"></a><span class="co">#&gt; #   norvegicus` &lt;dbl&gt;, `Astragalus onobrychis` &lt;dbl&gt;, `Astragalus oreades` &lt;dbl&gt;, ...</span></span></code></pre></div>
<p>Now we can start to examine the patterns in the data. Let’s plot richness as a function of longitude:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="kw">ggplot</span>(xgridded, <span class="kw">aes</span>(longitude, richness)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="st">  </span><span class="kw">theme_bw</span>()</span></code></pre></div>
<p><img src="SBDI4R_files/figure-html/unnamed-chunk-14-1.png" width="700"><!-- We see outliers in species richness that may be solved if names and synonyms are curated --><!-- as.data.frame(xgridded[xgridded$richness>200,]) --></p>
<p>Species richness as a function of environment:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">ggplot</span>(xgridded, <span class="kw">aes</span>(worldClimMeanTemperatureOfWarmestQuarter , </span>
<span id="cb14-2"><a href="#cb14-2"></a>                     worldClimAnnualPrecipitation, </span>
<span id="cb14-3"><a href="#cb14-3"></a>                     <span class="dt">colour=</span>richness)) <span class="op">+</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="st">  </span><span class="kw">scale_colour_distiller</span>(<span class="dt">palette=</span><span class="st">"Spectral"</span>) <span class="op">+</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size=</span><span class="dv">8</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="st">  </span><span class="kw">theme_bw</span>()</span></code></pre></div>
<p><img src="SBDI4R_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>Higher species richness in hottest areas.</p>
<p>How does the community composition change along the transect? Use clustering:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(vegan)</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="co">## Bray-Curtis dissimilarity</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>D &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/vegan/man/vegdist.html">vegdist</a></span>(xgridded[, sppcols], <span class="st">"bray"</span>)</span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="co">## UPGMA clustering</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>cl &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span>(D, <span class="dt">method=</span><span class="st">"ave"</span>)</span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="co">## plot the dendrogram</span></span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(cl)</span></code></pre></div>
<p><img src="SBDI4R_files/figure-html/unnamed-chunk-16-1.png" width="576"></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co">## extract group labels at the 20-group level</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>grp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span>(cl, <span class="dv">20</span>)</span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="co">## coalesce small (outlier) groups into a single catch-all group</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>sing &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(grp)<span class="op">&lt;</span><span class="dv">5</span>)</span>
<span id="cb16-5"><a href="#cb16-5"></a>grp[grp <span class="op">%in%</span><span class="st"> </span>sing] &lt;-<span class="st"> </span><span class="dv">21</span> <span class="co">## put these in a new combined group</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>grp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(grp, <span class="cf">function</span>(z)<span class="kw"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(grp)<span class="op">==</span>z)) <span class="co">## renumber groups</span></span>
<span id="cb16-7"><a href="#cb16-7"></a>xgridded<span class="op">$</span>grp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(grp)</span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="co">## plot</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="co">## colours for clusters</span></span>
<span id="cb16-10"><a href="#cb16-10"></a>thiscol &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#1f77b4"</span>, <span class="st">"#ff7f0e"</span>, <span class="st">"#2ca02c"</span>, <span class="st">"#d62728"</span>, <span class="st">"#9467bd"</span>, <span class="st">"#8c564b"</span>, <span class="st">"#e377c2"</span>,</span>
<span id="cb16-11"><a href="#cb16-11"></a>             <span class="st">"#7f7f7f"</span>, <span class="st">"#bcbd22"</span>, <span class="st">"#17becf"</span>)</span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="kw">ggplot</span>(xgridded, <span class="kw">aes</span>(longitude, latitude, <span class="dt">colour=</span>grp)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size=</span><span class="dv">5</span>) <span class="op">+</span></span>
<span id="cb16-14"><a href="#cb16-14"></a><span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values=</span>thiscol) <span class="op">+</span><span class="st"> </span></span>
<span id="cb16-15"><a href="#cb16-15"></a><span class="st">  </span><span class="kw">theme_bw</span>()</span></code></pre></div>
<p><img src="SBDI4R_files/figure-html/unnamed-chunk-16-2.png" width="576"></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co">## or a slightly nicer map plot</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(maps)</span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(mapdata)</span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="co">#&gt; Warning: package 'mapdata' was built under R version 3.6.3</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="kw">map</span>(<span class="st">"worldHires"</span>, <span class="st">"Sweden"</span>, </span>
<span id="cb17-6"><a href="#cb17-6"></a>    <span class="co"># xlim=c(105, 155), ylim=c(-45, -10), </span></span>
<span id="cb17-7"><a href="#cb17-7"></a>    <span class="dt">col=</span><span class="st">"gray90"</span>, <span class="dt">fill=</span><span class="ot">TRUE</span>)</span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(xgridded, <span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(longitude, latitude, <span class="dt">pch=</span><span class="dv">21</span>, <span class="dt">col=</span>thiscol[grp], <span class="dt">bg=</span>thiscol[grp], <span class="dt">cex=</span><span class="fl">0.75</span>))</span></code></pre></div>
<p><img src="SBDI4R_files/figure-html/unnamed-chunk-16-3.png" width="576"></p>
<!-- data_resources() NOT YET IMPLEMENTED -->
<!-- ### Example 6: Retrieve assertion information for datasets -->
<!-- Compare data quality metrics for data resources -->
<!-- ```{r} -->
<!-- dr <- data_resources(druid = c('dr1411','dr90','dr361'), extra = 'assertions') -->
<!-- ``` -->
<!-- ```{r eval = FALSE} -->
<!-- # View names of all columns returned -->
<!-- names(dr) -->
<!-- ``` -->
<!-- Extract the assertion metrics from the dataset -->
<!-- ```{r warning = FALSE} -->
<!-- library(tidyr) -->
<!-- # match cols against known assertions -->
<!-- assertions <- ala_fields('assertions') -->
<!-- assert_match <- names(dr)[names(dr) %in% assertions$name] -->
<!-- dr_assert <- dr %>% select(uid, all_of(assert_match)) %>% -->
<!--   pivot_longer(-uid, names_to = "assertion", values_to = "count") %>% -->
<!--   mutate(count = as.integer(trimws(as.character(count)))) %>% -->
<!--   # build axes labels with readable assertions -->
<!--   mutate(assertion_label = tolower(gsub('([A-Z])','\n\\1',assertion))) -->
<!-- ``` -->
<!-- Plot the assertions -->
<!-- ```{r warning=FALSE} -->
<!-- library(ggplot2) -->
<!-- ggplot(dr_assert) + geom_bar(aes(x = assertion_label, y = count, -->
<!--                                  fill = uid), -->
<!--                              stat = "identity", position = "dodge", -->
<!--                              width = 2/3) + -->
<!--   theme(axis.text.x = element_text(size = 7)) +  -->
<!--   labs(x = "Assertions") -->
<!-- ``` -->
<!-- ### Example 6: Retrieve assertion information for datasets -->
<!-- Compare data quality metrics for data resources -->
<!-- ```{r} -->
<!-- dr <- data_resources(druid = c('dr1411','dr90','dr361'), extra = 'assertions') -->
<!-- ``` -->
<!-- ```{r eval = FALSE} -->
<!-- # View names of all columns returned -->
<!-- names(dr) -->
<!-- ``` -->
<!-- Extract the assertion metrics from the dataset -->
<!-- ```{r warning = FALSE} -->
<!-- library(tidyr) -->
<!-- # match cols against known assertions -->
<!-- assertions <- ala_fields('assertions') -->
<!-- assert_match <- names(dr)[names(dr) %in% assertions$name] -->
<!-- dr_assert <- dr %>% select(uid, all_of(assert_match)) %>% -->
<!--   pivot_longer(-uid, names_to = "assertion", values_to = "count") %>% -->
<!--   mutate(count = as.integer(trimws(as.character(count)))) %>% -->
<!--   # build axes labels with readable assertions -->
<!--   mutate(assertion_label = tolower(gsub('([A-Z])','\n\\1',assertion))) -->
<!-- ``` -->
<!-- Plot the assertions -->
<!-- ```{r warning=FALSE} -->
<!-- library(ggplot2) -->
<!-- ggplot(dr_assert) + geom_bar(aes(x = assertion_label, y = count, -->
<!--                                  fill = uid), -->
<!--                              stat = "identity", position = "dodge", -->
<!--                              width = 2/3) + -->
<!--   theme(axis.text.x = element_text(size = 7)) +  -->
<!--   labs(x = "Assertions") -->
<!-- ``` -->
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#using-sbdi4r">Using SBDI4R</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Debora Arlt, Alejandro Ruete, Anton Hammarström, Marcus Lindh.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
